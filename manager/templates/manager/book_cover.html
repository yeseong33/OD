{% extends 'manager/template.html' %}
{% load static %}

{% block content %}
<style>
    .search-bar-container {
        position: absolute;
        top: 80px;
        right: 95px;
        width: 230px; /* ê²€ìƒ‰ë°”ì˜ ë„ˆë¹„ */
        height: 40px;
        display: flex;
        align-items: center;
        background-color: #fff;
        border-radius: 20px;
        padding: 5px 1px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .search-bar-container input[type="text"] {
        flex-grow: 1;
        border: none;
        padding: 5px 10px;
        margin-right: 5px;
        border-radius: 15px;
        outline: none;
        font-size: 12px;
    }

    .search-bar-container button {
        border: none;
        background-color: #F0CB85;
        color: white;
        padding: 6px 12px;
        border-radius: 15px;
        cursor: pointer;
        width: 40px;
        height: 30px;
        font-size: 12px;
    }

    .search-bar-container button:hover {
        background-color: #FFA01E;
    }

    .search-results {
        list-style: none;
        margin: 0;
        padding: 0;
        position: absolute;
        top: 120px; /* ê²€ìƒ‰ë°”ì˜ ë†’ì´ì™€ ìœ„ì¹˜ì— ë”°ë¼ ì¡°ì ˆ */
        right: 95px;
        width: 230px; /* ê²€ìƒ‰ë°”ì˜ ë„ˆë¹„ì™€ ì¼ì¹˜ */
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 1000; /* ë‹¤ë¥¸ ìš”ì†Œë“¤ ìœ„ì— í‘œì‹œ */
    }

    .search-results li {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
    }

    .search-results li:hover {
        background-color: #f0f0f0;
    }
    /* ... ê¸°ì¡´ CSS ìŠ¤íƒ€ì¼ ... */
    .cover-selection,
    .cover-selection + .button-group {
        display: none; /* ì´ˆê¸° ìƒíƒœë¥¼ ìˆ¨ê¹€ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤. */
    }
    .cover-creation-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center; /* ëª¨ë“  ë‚´ìš©ì„ ê°€ìš´ë° ì •ë ¬í•©ë‹ˆë‹¤. */
        margin: 10px;
        padding: 60px;
        background-color: #f9f9f9;

        
    }
    .button-group .cover-button {
        padding: 5px 10px;
        border: none;
        border-radius: 25px; /* ë²„íŠ¼ì„ ë‘¥ê¸€ê²Œ ë§Œë“­ë‹ˆë‹¤. */
        margin: 5px; /* ê° ë²„íŠ¼ ì‚¬ì´ì˜ ê°„ê²©ì„ ì¡°ì ˆí•©ë‹ˆë‹¤. */
        background-color: #F0CB85;
        color: black;
        font-size: 15px;
        cursor: pointer;
        transition: background-color 0.3s;
        width: 80px; /* ë²„íŠ¼ì˜ ë„ˆë¹„ë¥¼ ê³ ì •í•©ë‹ˆë‹¤. */
        height: 48px; /* ë²„íŠ¼ì˜ ë†’ì´ë¥¼ ê³ ì •í•©ë‹ˆë‹¤. */
        text-align: center; /* í…ìŠ¤íŠ¸ë¥¼ ê°€ìš´ë° ì •ë ¬í•©ë‹ˆë‹¤. */
        line-height: 40px; /* í…ìŠ¤íŠ¸ë¥¼ ìˆ˜ì§ ì¤‘ì•™ì— ë°°ì¹˜í•©ë‹ˆë‹¤. */
    }
    
    .button-group .cover-button2 {
        padding: 10px 20px;
        border: none;
        border-radius: 25px; /* ë²„íŠ¼ì„ ë‘¥ê¸€ê²Œ ë§Œë“­ë‹ˆë‹¤. */
        margin: 5px; /* ê° ë²„íŠ¼ ì‚¬ì´ì˜ ê°„ê²©ì„ ì¡°ì ˆí•©ë‹ˆë‹¤. */
        background-color: #FFA01E;
        color: black;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .button-group .cover-button:hover,
    .button-group .cover-button.clicked {
        background-color: #FFA01E;
    }
    .button-group .image-button:hover,
    .button-group .image-button.clicked {
        background-color: #FFA01E;
    }
    
    h2 {
        margin-bottom: 15px;
        color: #333;
        font-family: 'Arial', sans-serif;
        font-weight: bold; /* ê¸€ê¼´ì„ êµµê²Œ ë§Œë“­ë‹ˆë‹¤. */
        font-size: 24px; /* ì›í•˜ëŠ” ê¸€ê¼´ í¬ê¸°ë¡œ ì¡°ì ˆí•©ë‹ˆë‹¤. */
    }
    .button-group .image-button {
        border: 1px solid orange; /* í…Œë‘ë¦¬ ìŠ¤íƒ€ì¼ ë° ìƒ‰ìƒì„ ì£¼í™©ìƒ‰ìœ¼ë¡œ ì§€ì •í•©ë‹ˆë‹¤. */
        margin: 5px;
        color: white;
        font-size: 16px;
        cursor: pointer; 
    }

    .layout-container {
        display: flex;
        justify-content: space-between; /* This separates the two sections */
        width: 100%;
    }
    
    /* This will be your left section for the local image */
    .local-image-section {
        flex-basis: 40%; /* Takes up half the width */
        display: flex;
        justify-content: left;
        align-items: left; /* This centers the content */
    }
    
    /* Assuming your right section is already implemented */
    .cover-creation-section {
        flex-basis: 60%; /* Takes up the other half */
        /* Your existing styles */
    }
    
    /* You might need to adjust your image styles for responsiveness */
    img {
        max-width: 100%;
        height: auto;
    }
    
    .loading-indicator {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000; /* í™”ë©´ì˜ ë‹¤ë¥¸ ìš”ì†Œë“¤ ìœ„ì— í‘œì‹œë˜ë„ë¡ z-index ì„¤ì • */
    }

</style>

<div id="loadingIndicator" class="loading-indicator" style="display: none;">
    <img src="{% static 'images/loading.gif' %}" alt="Loading..." />
</div>


<div class="cover-creation-section">
    <div class="layout-container">
        <div class="local-image-section">
            <!-- Place your image tag here -->
            <img id="graphImage" src="{% static 'images/ready.gif' %}" alt="Ready Image" style="width: 1500px; height: auto;">
        </div>
        
        <!-- Your existing cover-creation-section -->
        <div class="cover-creation-section">
            <div class="search-bar-container">
                <input type="text" placeholder="ê²€ìƒ‰...">
                <button>ğŸ“™</button>
                <ul id="searchResults" class="search-results" style="display: none;">
                    <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤ -->
                </ul>
            </div>
            <h2>í‘œì§€ ë³€ê²½ ì˜µì…˜</h2>

            <!-- ë²„íŠ¼ ê·¸ë£¹ 1 -->
            <div class="button-group">
                <button id="StyleBtn" class="cover-button">#ë””ì¦ˆë‹ˆ</button>
                <button id="StyleBtn" class="cover-button">#ì§€ë¸Œë¦¬</button>
                <button id="StyleBtn" class="cover-button"># ë§ˆë¸”  </button>
            </div>

            <!-- ë²„íŠ¼ ê·¸ë£¹ 2 -->
            <div class="button-group">
                <button id="StyleBtn" class="cover-button"># ì¹´íˆ°  </button>
                <button id="StyleBtn" class="cover-button">#ì»¬ëŸ¬í’€</button>
                <button id="StyleBtn" class="cover-button">#ë“œë¡œì‰</button>
            </div>

            <div class="button-group">
                <button id="createCoverBtn" class="cover-button2">í‘œì§€ ìƒì„±í•˜ê¸°</button>
            </div>

            
            <!-- Cover Selection Area -->
            <div class="cover-selection">
                <div class="button-group">
                <!-- ì´ë¯¸ì§€ ë²„íŠ¼ 1 -->
                    <button class="image-button" onclick="selectImage(0)">
                        <img src="{% static 'images/Redraw_image_0.png' %}" alt="Image0" style="width: 180px; height: 200px;">
                    </button>
                    <!-- ì´ë¯¸ì§€ ë²„íŠ¼ 2 -->
                    <button class="image-button" onclick="selectImage(1)">
                        <img src="{% static 'images/Redraw_image_1.png' %}" alt="Image1" style="width: 180px; height: 200px;">
                    </button>
                    <!-- ì´ë¯¸ì§€ ë²„íŠ¼ 3 -->
                    <button class="image-button" onclick="selectImage(2)">
                        <img src="{% static 'images/Redraw_image_2.png' %}" alt="Image2" style="width: 180px; height: 200px;">
                    </button>
                </div>
            </div>

            <div class="button-group">
                <button id="selectCoverBtn" class="cover-button2">í‘œì§€ ë³€ê²½í•˜ê¸°</button>
            </div>
                </div>
            </div>
    <!-- Cover Creation Area -->
        </div>
    </div>
</div>


{% endblock %}

{% block script %}
<script type="text/javascript">
    // local-image-sectionì˜ ì´ë¯¸ì§€ë¥¼ ì¬ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
    function reloadLocalImage() {
        var localImage = document.querySelector('.local-image-section img');
        localImage.src = "{% static 'images/graph.png' %}?t=" + new Date().getTime();
    }

    function showLoadingIndicator() {
        document.getElementById('loadingIndicator').style.display = 'block';
    }
    
    function hideLoadingIndicator() {
        document.getElementById('loadingIndicator').style.display = 'none';
    }

    function toggleButtonClass(button) {
        if (button.classList.contains('clicked')) {
            button.classList.remove('clicked'); // ì´ë¯¸ clicked í´ë˜ìŠ¤ê°€ ìˆë‹¤ë©´ ì œê±°
        } else {
            // ë‹¤ë¥¸ ëª¨ë“  ë²„íŠ¼ì˜ clicked í´ë˜ìŠ¤ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
            const allButtons = document.querySelectorAll('.cover-button');
            allButtons.forEach(function(btn) {
                btn.classList.remove('clicked');
            });
            button.classList.add('clicked'); // clicked í´ë˜ìŠ¤ë¥¼ ì¶”ê°€
        }
    }

    const styleButtons = document.querySelectorAll('.button-group .cover-button');
    styleButtons.forEach(button => {
        button.addEventListener('click', function() {
        // ë‹¤ë¥¸ ëª¨ë“  ìŠ¤íƒ€ì¼ ë²„íŠ¼ì˜ 'clicked' í´ë˜ìŠ¤ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
            styleButtons.forEach(btn => {
                btn.classList.remove('clicked');
        });
        // í˜„ì¬ í´ë¦­ëœ ë²„íŠ¼ì— 'clicked' í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
        button.classList.add('clicked');
    });
});
    
    const imageButtons = document.querySelectorAll('.cover-selection .image-button');
    imageButtons.forEach(button => {
        button.addEventListener('click', function() {
            // ë‹¤ë¥¸ ëª¨ë“  ì´ë¯¸ì§€ ë²„íŠ¼ì˜ 'clicked' í´ë˜ìŠ¤ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
            imageButtons.forEach(btn => {
                btn.classList.remove('clicked');
            });
            // í˜„ì¬ í´ë¦­ëœ ë²„íŠ¼ì— 'clicked' í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
            button.classList.add('clicked');
        });
    });

    // í‘œì§€ ìƒì„± ë²„íŠ¼ì— ëŒ€í•œ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    const createCoverBtn = document.getElementById('createCoverBtn');
    createCoverBtn.addEventListener('click', function() {
        // í´ë¦­ëœ ë²„íŠ¼ì— 'clicked' í´ë˜ìŠ¤ë¥¼ í† ê¸€í•©ë‹ˆë‹¤.
        createCoverBtn.classList.toggle('clicked');
    });

    // í‘œì§€ ë³€ê²½ ë²„íŠ¼ì— ëŒ€í•œ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    const selectCoverBtn = document.getElementById('selectCoverBtn');
    selectCoverBtn.addEventListener('click', function() {
        // í´ë¦­ëœ ë²„íŠ¼ì— 'clicked' í´ë˜ìŠ¤ë¥¼ í† ê¸€í•©ë‹ˆë‹¤.
        selectCoverBtn.classList.toggle('clicked');
    });
    // CSRF í† í°ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // í‘œì§€ ìƒì„±í•˜ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    document.getElementById('createCoverBtn').addEventListener('click', function() {
        showLoadingIndicator();
        const selectedStyleButton = document.querySelector('.button-group .cover-button.clicked');
        let selectedStyle = '';
        if (selectedStyleButton) {
            selectedStyle = selectedStyleButton.textContent.trim(); // ë²„íŠ¼ì˜ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
        }
        fetch('', {  // '/create_cover/'ëŠ” ì¥ê³  urlconfì— ì •ì˜ëœ ê²½ë¡œì— ë§ê²Œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),  // CSRF í† í°ì„ ìš”ì²­ í—¤ë”ì— ì¶”ê°€í•©ë‹ˆë‹¤.
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                // ì—¬ê¸°ì— ì„œë²„ì— ë³´ë‚¼ ë°ì´í„°ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                request_type: 'create_cover',
                style: selectedStyle, //ë””ì¦ˆë‹ˆ or ë§ˆë¸”.. ê·¸ë¦¼ì²´ ì „ì†¡
            })
        })
        .then(response => {
            hideLoadingIndicator();
            response.json();
        })
        .then(data => {
            document.querySelector('.cover-selection').style.display = 'block';
            document.querySelector('.cover-selection + .button-group').style.display = 'block';
            const newTimestamp = new Date().getTime();
            const imageElements = document.querySelectorAll('.cover-selection img');
            imageElements.forEach((img, index) => {
                img.src = `{% static 'images/Redraw_image_' %}${index}.png?${newTimestamp}`;
            });
            alert(data.message);  // ì„œë²„ë¡œë¶€í„° ì‘ë‹µì„ ë°›ìœ¼ë©´ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ì„ í‘œì‹œí•©ë‹ˆë‹¤.
            // í•„ìš”í•œ ì¶”ê°€ ë™ì‘
        })
        .catch((error) => {
            hideLoadingIndicator();
            console.error('Error:', error);
        });
    });



    // 'í‘œì§€ ë³€ê²½í•˜ê¸°' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    document.getElementById('selectCoverBtn').addEventListener('click', function() {
        // í˜„ì¬ ì„ íƒëœ ì´ë¯¸ì§€ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        const selectedImageNumber = getCurrentSelectedImageNumber();
        if (selectedImageNumber === null) {
            alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
            return;
        }
    
        // ì„ íƒëœ ì´ë¯¸ì§€ ë²ˆí˜¸ ì„œë²„ì— ì „ì†¡
        fetch('', { // ì„œë²„ ê²½ë¡œë¥¼ ì ì ˆíˆ ìˆ˜ì •í•˜ì„¸ìš”.
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                request_type: 'update_cover',
                image_number: selectedImageNumber
            })
        })
        .then(response => response.json())
        .then(data => {
            alert('ë³€ê²½ ì„±ê³µ!');
            window.location.href = '../cover_complete';
            
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ë³€ê²½ ì‹¤íŒ¨');
        });
    });
    

    function selectImage(imageNumber) {
        const imageButtons = document.querySelectorAll('.cover-selection .image-button');
        imageButtons.forEach(button => {
            button.classList.remove('clicked'); // ë‹¤ë¥¸ ëª¨ë“  ë²„íŠ¼ì˜ 'clicked' í´ë˜ìŠ¤ ì œê±°
        });
    
        const selectedButton = document.querySelector(`.cover-selection .image-button:nth-child(${imageNumber})`);
        selectedButton.classList.add('clicked'); // ì„ íƒëœ ë²„íŠ¼ì— 'clicked' í´ë˜ìŠ¤ ì¶”ê°€
    }
    function getCurrentSelectedImageNumber() {
        const selectedButton = document.querySelector('.cover-selection .image-button.clicked');
        if (!selectedButton) {
            return null;
        }
        return Array.from(document.querySelectorAll('.cover-selection .image-button')).indexOf(selectedButton);
    }
    
    
    
    // ê²€ìƒ‰ ì²˜ë¦¬ ë¡œì§ 
    document.querySelector('.search-bar-container button').addEventListener('click', function() {
        const searchText = document.querySelector('.search-bar-container input[type="text"]').value;
        const searchResults = document.getElementById('searchResults');
        searchResults.style.display = 'none';
        // AJAX ìš”ì²­ ì „ ì´ë¯¸ì§€ë¥¼ ready.pngë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
        document.getElementById('graphImage').src = "{% static 'images/ready.gif' %}";
    
        fetch('', { // Django ë·° ê²½ë¡œë¡œ ìˆ˜ì •í•˜ì„¸ìš”
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                request_type: 'create_graph',
                search_text: searchText
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('ê²€ìƒ‰ ê²°ê³¼:', data);
            // ê²€ìƒ‰ ì™„ë£Œ í›„ ì´ë¯¸ì§€ë¥¼ graph.pngë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
            document.getElementById('graphImage').src = "{% static 'images/graph.png' %}";
            // ì—¬ê¸°ì— ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì¶”ê°€ ë¡œì§ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        })
        .catch(error => {
            console.error('Error:', error);
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì´ë¯¸ì§€ë¥¼ ë‹¤ì‹œ ready.pngë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            alert('ì±… ì œëª©ì„ ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”');
            document.getElementById('graphImage').src = "{% static 'images/ready.gif' %}";
        });
    });
    document.querySelector('.search-bar-container input[type="text"]').addEventListener('input', function() {
        const searchText = this.value;
    
        fetch('', {  // ì ì ˆí•œ URLë¡œ ë³€ê²½í•˜ì„¸ìš”
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                request_type: 'search',
                search_query: searchText })
        })
        .then(response => response.json())
        .then(data => {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';  // ì´ì „ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì§€ì›ë‹ˆë‹¤
            searchResults.style.display = 'block';  // ëª©ë¡ì„ í‘œì‹œí•©ë‹ˆë‹¤
    
            data.books.forEach(book => {
                const listItem = document.createElement('li');
                listItem.textContent = book.title;
                searchResults.appendChild(listItem);
            });
    
            if (data.books.length === 0) {
                searchResults.innerHTML = '<li>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
    function setupSearchResultClickListener() {
        const searchResults = document.getElementById('searchResults');
        searchResults.addEventListener('click', function(event) {
            const clickedItem = event.target;
            if (clickedItem.tagName === 'LI') {
                const searchBar = document.querySelector('.search-bar-container input[type="text"]');
                searchBar.value = clickedItem.textContent.trim();
            }
        });
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
    document.addEventListener('DOMContentLoaded', function() {
        setupSearchResultClickListener();
    });

</script>
{% endblock %}

