{% extends 'audiobook/template.html' %}
{% load static %}

{% block title %}청취{% endblock %}

{% block style %}
<style>
    #voice_img {
        object-fit: cover; 
        cursor:pointer;
    }
</style>
{% endblock %}

{% block content %}
    <!-- 공백 -->
    <div class="row my-5">
        <h1 class="menu-font">{{book.book_title}}</h1>
    </div>

    <div class="row justify-content-center">
        <!-- 책 표지 -->
        <div class="col-6 d-flex align-items-center justify-content-start">
            <img src="{{file_path}}{{book.book_image_path}}" alt="사진" class="img-fluid rounded"> 
        </div>

        <!-- 성우 선택 -->
        <div class="col-6 d-flex flex-column align-items-center justify-content-center">
            <div class="row mb-4">
                <img id="voice_img" src="/static/images/chz.jpg" alt="성우 사진" class="img-fluid rounded">
            </div>
            <div class="row">
                <div class="col-auto d-flex justify-content-center">
                    <span class="fs-3 fw-bold mx-1">현재 선택 성우</span>
                    <span id="sampleBtn" class="d-inline-flex align-items-center" style="cursor:pointer;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="#FD7E14"  class="bi bi-play" viewBox="0 0 16 16">
                            <path d="M10.804 8 5 4.633v6.734zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696z"/>
                        </svg>
                    </span>  
                </div>
            </div>
        </div>
    </div>

    <!-- 청취 버튼 -->
    <div class="row d-flex align-items-center justify-content-center my-5">
        <div id="listen" class="col-auto d-flex align-items-center" style="cursor:pointer;">
            <button class="btn btn-orange-400 btn-lg">청취하기</button>
        </div>
    </div>

    <audio id="audioPlayer" style="display: none">
        <source src="/static/sounds/dog_bark.mp3" type="audio/mp3">
    </audio>
{% endblock %}

{% block script %}
    <script>
        var isPlaying = false; // 소리가 현재 재생 중인지 여부를 나타내는 변수
        const user_book_history = {{user_book_history}}
        const bookId = {{book.book_id}}
        if (!user_book_history.includes(bookId)) {
            user_book_history.push(bookId)
        }
        
        document.getElementById('listen').addEventListener('click', function() {
            // 쿠키에서 CSRF 토큰을 가져오는 함수
            function getCSRFToken() {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith('csrftoken=')) {
                        return cookie.substring('csrftoken='.length, cookie.length);
                    }
                }
                return null;
            }
            // CSRF 토큰 가져오기
            const csrfToken = getCSRFToken();
            // CSRF 토큰이 있는지 확인
            if (!csrfToken) {
                console.error("CSRF 토큰을 찾을 수 없습니다.");
                return;
            }

            fetch("{% url 'community:user_detail' pk=user.user_id%}", {
            method: "PUT",  // 또는 "GET" 등 요청 방식 선택
            headers: {
                "Content-Type": "application/json",
                // 헤더에 CSRF 토큰 포함
                "X-CSRFToken": csrfToken,
                },
                body: JSON.stringify({user_book_history: user_book_history}),
            })
            .then(data => {
                // 성공적으로 데이터를 받아온 경우 실행되는 로직
                window.location.href = "{% url 'audiobook:content_play' book_id=book.book_id %}"
            })
            .catch(error => {
                console.error("좋아요 업데이트 중 오류 발생", error);
            });

        }); 

        document.getElementById('voice_img').addEventListener('click', function() {
            window.location.href = "{% url 'audiobook:voice_custom' %}"
        }); 

        document.getElementById('sampleBtn').addEventListener('click', function() {
            playSample();
        });

        function playSample() {
            var audioPlayer = document.getElementById('audioPlayer');
            if (!isPlaying) {
                audioPlayer.play();
                isPlaying = true;
            } else {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                isPlaying = false;
            }
        }

    </script>
{% endblock %}